let
    // Section 1: Get all files, parse timestamps, and invoke the transform function on ALL of them.
    Source = SharePoint.Files("https://abbott.sharepoint.com/sites/GB-AN-HeadOffice", [ApiVersion = 15]),
    #"Filtered Rows" = Table.SelectRows(Source, each ([Folder Path] = "https://abbott.sharepoint.com/sites/GB-AN-HeadOffice/Shared Documents/General/Demand/DP Master Download/")),
    #"Filtered Hidden Files" = Table.SelectRows(#"Filtered Rows", each [Attributes]?[Hidden]? <> true),
    #"Added TimestampText" = Table.AddColumn(#"Filtered Hidden Files", "TimestampText", each Text.Middle([Name], 29, 19)),
    #"Replaced Underscore" = Table.ReplaceValue(#"Added TimestampText","_","T",Replacer.ReplaceText,{"TimestampText"}),
    #"Added TimestampFixed" = Table.AddColumn(#"Replaced Underscore", "TimestampFixed", each Text.Start([TimestampText], 10) & "T" & Text.Middle([TimestampText], 11, 2) & ":" & Text.Middle([TimestampText], 14, 2) & ":" & Text.End([TimestampText], 2)),
    #"Changed Type" = Table.TransformColumnTypes(#"Added TimestampFixed",{{"TimestampFixed", type datetime}}),
    
    // Invoke the transform function on ALL files. This is necessary for the business logic.
    #"Invoked Custom Function" = Table.AddColumn(#"Changed Type", "Transform File", each #"Transform File"([Content])),
    
    // We need the TimestampFixed column alongside the transformed data.
    #"Removed Other Columns" = Table.SelectColumns(#"Invoked Custom Function",{"TimestampFixed", "Transform File"}),
    
    // Expand the pre-processed data from ALL files. This will be a large table, but the transformation is already done.
    #"Expanded Table Column" = Table.ExpandTableColumn(#"Removed Other Columns", "Transform File", {"Country", "Local Item number", "APO Product (1-6-3-3)", "APO Customer", "Column8", "Location/Plant/Site", "Key Figures", "Calendar year", "Calendar month", "Column14", "IsIncluded", "NewKeyFigure"}),

    // Section 2: Find the latest data FOR EACH CALENDAR YEAR (the user's original, correct logic)
    // This operates on the large, combined table.
    #"Grouped by Data Year" = Table.Group(#"Expanded Table Column", {"Calendar year"}, {{"AllData", each _, type table}, {"LatestTimestamp", each List.Max([TimestampFixed]), type datetime}}),
    
    // Rename the grouping column to avoid conflict during the next expansion
    #"Renamed Grouping Column" = Table.RenameColumns(#"Grouped by Data Year",{{"Calendar year", "Calendar year.Group"}}),

    // Expand the data again to get all columns back
    #"Expanded AllData" = Table.ExpandTableColumn(#"Renamed Grouping Column", "AllData", Table.ColumnNames(#"Expanded Table Column")),
    
    // Filter the rows to keep only those that come from the latest file for that specific calendar year's data.
    #"Filtered Latest Only" = Table.SelectRows(#"Expanded AllData", each [TimestampFixed] = [LatestTimestamp]),

    // Section 3: Final filtering and grouping (now on the correctly filtered dataset)
    #"Filtered Rows to Keep" = Table.SelectRows(#"Filtered Latest Only", each [IsIncluded] = true),
    #"Renamed Columns" = Table.RenameColumns(#"Filtered Rows to Keep",{{"Column8", "APO Customer Name"}, {"Column14", "Data"}}),
    
    // Group the final rows.
    #"Grouped Rows for Final Output" = Table.Group(#"Renamed Columns", 
        {"Country", "Local Item number", "APO Product (1-6-3-3)", "APO Customer", "APO Customer Name", "Location/Plant/Site", "Calendar year", "Calendar month", "NewKeyFigure"}, 
        {{"Data", each List.Sum([Data]), type nullable number}}
    ),
    
    // Final cleanup
    #"Renamed Key Figure Column" = Table.RenameColumns(#"Grouped Rows for Final Output", {{"NewKeyFigure", "Key Figures"}})

in
    #"Renamed Key Figure Column"
