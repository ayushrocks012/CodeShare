let
    // Section 1: Load file list and invoke the powerful transform function
    Source = SharePoint.Files("https://abbott.sharepoint.com/sites/GB-AN-HeadOffice", [ApiVersion = 15]),
    #"Filtered Rows" = Table.SelectRows(Source, each ([Folder Path] = "https://abbott.sharepoint.com/sites/GB-AN-HeadOffice/Shared Documents/General/Demand/DP Master Download/")),
    #"Added TimestampText" = Table.AddColumn(#"Filtered Rows", "TimestampText", each Text.Middle([Name], 29, 19)),
    #"Replaced Underscore" = Table.ReplaceValue(#"Added TimestampText","_","T",Replacer.ReplaceText,{"TimestampText"}),
    #"Added TimestampFixed" = Table.AddColumn(#"Replaced Underscore", "TimestampFixed", each Text.Start([TimestampText], 10) & "T" & Text.Middle([TimestampText], 11, 2) & ":" & Text.Middle([TimestampText], 14, 2) & ":" & Text.End([TimestampText], 2)),
    #"Changed Type" = Table.TransformColumnTypes(#"Added TimestampFixed",{{"TimestampFixed", type datetime}}),
    #"Filtered Hidden Files" = Table.SelectRows(#"Changed Type", each [Attributes]?[Hidden]? <> true),
    
    // The Invoked Custom Function step now calls our more powerful "Transform File" function
    #"Invoked Custom Function" = Table.AddColumn(#"Filtered Hidden Files", "Transform File", each #"Transform File"([Content])),
    
    // We only need the timestamp and the pre-processed table data now
    #"Removed Other Columns" = Table.SelectColumns(#"Invoked Custom Function",{"TimestampFixed", "Transform File"}),
    
    // Expand the pre-processed data. Note the new columns "IsIncluded" and "NewKeyFigure" are now available.
    #"Expanded Table Column" = Table.ExpandTableColumn(#"Removed Other Columns", "Transform File", {"Country", "Local Item number", "APO Product (1-6-3-3)", "APO Customer", "Column8", "Location/Plant/Site", "Key Figures", "Calendar year", "Calendar month", "Column14", "IsIncluded", "NewKeyFigure"}),

    // Section 2: Find and filter for the latest file per year (this logic must remain here)
    #"Grouped by Year" = Table.Group(#"Expanded Table Column", {"Calendar year"}, {{"AllData", each _, type table}}),
    #"Added LatestTimestamp" = Table.AddColumn(#"Grouped by Year", "LatestTimestamp", each List.Max([AllData][TimestampFixed])),
    #"Renamed Grouping Column" = Table.RenameColumns(#"Added LatestTimestamp",{{"Calendar year", "Calendar year.Group"}}),
    #"Expanded AllData" = Table.ExpandTableColumn(#"Renamed Grouping Column", "AllData", Table.ColumnNames(#"Expanded Table Column")),
    #"Filtered Latest Only" = Table.SelectRows(#"Expanded AllData", each [TimestampFixed] = [LatestTimestamp]),

    // Section 3: Final filtering and grouping on the much smaller, pre-processed dataset
    #"Filtered Rows to Keep" = Table.SelectRows(#"Filtered Latest Only", each [IsIncluded] = true),
    #"Renamed Columns" = Table.RenameColumns(#"Filtered Rows to Keep",{{"Column8", "APO Customer Name"}, {"Column14", "Data"}}),
    
    // Group the final rows. This is much faster as it operates on a heavily pre-filtered table.
    #"Grouped Rows for Final Output" = Table.Group(#"Renamed Columns", 
        {"Country", "Local Item number", "APO Product (1-6-3-3)", "APO Customer", "APO Customer Name", "Location/Plant/Site", "Calendar year", "Calendar month", "NewKeyFigure"}, 
        {{"Data", each List.Sum([Data]), type nullable number}}
    ),
    
    // Final cleanup
    #"Renamed Key Figure Column" = Table.RenameColumns(#"Grouped Rows for Final Output", {{"NewKeyFigure", "Key Figures"}})

in
    #"Renamed Key Figure Column"
