Public SapGuiAuto, WScript, msgcol
Public objGui       As GuiApplication
Public objConn      As GuiConnection
Public objSess      As GuiSession
Public objSBar      As GuiStatusbar
Dim Result1, Result2
Public Const W_System As String = "PEA100"
Public Const Max_Possible_Session As Integer = 6

Sub StartExtract()

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    Result1 = ""
    Result2 = ""

    Dim i, j
    Dim W_conn, W_Sess
    Dim W_Ret As Boolean

    If W_System = "" Then
        GoTo Cleanup
    End If

    If Not objSess Is Nothing Then
        If objSess.Info.SystemName & objSess.Info.Client = W_System Then
            W_Ret = True
            GoTo RunScript
        End If
    End If

    If objGui Is Nothing Then
        Set SapGuiAuto = GetObject("SAPGUI")
        Set objGui = SapGuiAuto.GetScriptingEngine
    End If

    Session_Nr = -1

    For i = 0 To objGui.Children.Count - 1
        Set W_conn = objGui.Children(i + 0)
        Session_Nr_All = W_conn.Children.Count
        For j = 0 To W_conn.Children.Count - 1
            Set W_Sess = W_conn.Children(j + 0)
            If W_Sess.Info.SystemName & W_Sess.Info.Client = W_System Then
                If W_Sess.Info.Transaction = "SESSION_MANAGER" Or W_Sess.Info.Transaction = "SMEN" Or W_Sess.Info.Transaction = "S000" Then
                    Session_Nr = W_Sess.Info.SessionNumber - 1
                    Set objConn = objGui.Children(i + 0)
                    Set objSess = objConn.Children(j + 0)
                    W_Ret = True
                    GoTo RunScript
                End If
            End If
        Next
    Next

    If Session_Nr_All = Max_Possible_Session And Session_Nr = -1 Then
        Result1 = MsgBox("Maximum number of sessions reached", vbCritical + vbOKOnly)
        GoTo Cleanup
    End If

    If Session_Nr = -1 Then
        Result2 = MsgBox("No active session to system " + W_System + ", or scripting is not enabled.", vbCritical + vbOKOnly)
        GoTo Cleanup
    End If

    If IsObject(WScript) Then
        WScript.ConnectObject objSess, "on"
        WScript.ConnectObject objGui, "on"
    End If

    If Not objSess Is Nothing Then
        Set objSBar = objSess.FindById("wnd[0]/sbar")
    End If

RunScript:
    If W_Ret Then
        RunGUIScript
        objSess.EndTransaction
        Set objSess = Nothing
    End If

Cleanup:
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True

End Sub

Public Sub RunGUIScript()

    objSess.FindById("wnd[0]/tbar[0]/okcd").Text = "mb51"
    objSess.FindById("wnd[0]").sendVKey 0
    objSess.FindById("wnd[0]/usr/ctxtWERKS-LOW").Text = "1534"
    objSess.FindById("wnd[0]/usr/ctxtBUDAT-LOW").Text = "01.03.2025"
    objSess.FindById("wnd[0]/usr/ctxtBUDAT-HIGH").Text = "31.03.2025"
    objSess.FindById("wnd[0]/usr/radRFLAT_L").Select
    objSess.FindById("wnd[0]/usr/ctxtALV_DEF").Text = "AYUSH_TRY"
    objSess.FindById("wnd[0]/tbar[1]/btn[8]").press
    objSess.FindById("wnd[0]/usr/cntlGRID1/shellcont/shell").ContextMenu
    objSess.FindById("wnd[0]/usr/cntlGRID1/shellcont/shell").SelectContextMenuItem "&XXL"
    objSess.FindById("wnd[1]/tbar[0]/btn[0]").press
    objSess.FindById("wnd[1]/usr/ctxtDY_PATH").Text = "Z:\Demand\Demand Review\2025\03 Mar 25\SAP H2H Report"
    objSess.FindById("wnd[1]/usr/ctxtDY_FILENAME").Text = "H2H Usage Report v4.XLSX"
    objSess.FindById("wnd[1]/tbar[0]/btn[0]").press
    objSess.FindById("wnd[0]/tbar[0]/btn[15]").press
    objSess.FindById("wnd[0]/tbar[0]/btn[15]").press

End Sub
