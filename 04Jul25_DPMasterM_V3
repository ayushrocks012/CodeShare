let
    // Section 1: Get all files and invoke the highly optimized transform function. This part is unchanged.
    Source = SharePoint.Files("https://abbott.sharepoint.com/sites/GB-AN-HeadOffice", [ApiVersion = 15]),
    #"Filtered Rows" = Table.SelectRows(Source, each ([Folder Path] = "https://abbott.sharepoint.com/sites/GB-AN-HeadOffice/Shared Documents/General/Demand/DP Master Download/")),
    #"Filtered Hidden Files" = Table.SelectRows(#"Filtered Rows", each [Attributes]?[Hidden]? <> true),
    #"Added TimestampText" = Table.AddColumn(#"Filtered Hidden Files", "TimestampText", each Text.Middle([Name], 29, 19)),
    #"Replaced Underscore" = Table.ReplaceValue(#"Added TimestampText","_","T",Replacer.ReplaceText,{"TimestampText"}),
    #"Added TimestampFixed" = Table.AddColumn(#"Replaced Underscore", "TimestampFixed", each Text.Start([TimestampText], 10) & "T" & Text.Middle([TimestampText], 11, 2) & ":" & Text.Middle([TimestampText], 14, 2) & ":" & Text.End([TimestampText], 2)),
    #"Changed Type" = Table.TransformColumnTypes(#"Added TimestampFixed",{{"TimestampFixed", type datetime}}),
    #"Invoked Custom Function" = Table.AddColumn(#"Changed Type", "Transform File", each #"Transform File"([Content])),
    #"Removed Other Columns" = Table.SelectColumns(#"Invoked Custom Function",{"TimestampFixed", "Transform File"}),
    #"Expanded Table Column" = Table.ExpandTableColumn(#"Removed Other Columns", "Transform File", {"Country", "Local Item number", "APO Product (1-6-3-3)", "APO Customer", "Column8", "Location/Plant/Site", "Key Figures", "Calendar year", "Calendar month", "Column14", "IsIncluded", "NewKeyFigure"}),

    // *** OPTIMIZATION: Buffer the large table in memory to prevent re-evaluation ***
    BufferedData = Table.Buffer(#"Expanded Table Column"),

    // Section 2: Group the data by year and, within each group, filter for the latest records. This avoids the slow "double expansion".
    #"Grouped and Filtered" = Table.Group(BufferedData, {"Calendar year"}, {
        {"FilteredRows", (group) => 
            let
                LatestTimestampInGroup = List.Max(group[TimestampFixed]),
                Result = Table.SelectRows(group, each [TimestampFixed] = LatestTimestampInGroup)
            in
                Result
        , type table}
    }),

    // Combine the small, pre-filtered tables from the grouping step into one final table.
    #"Combined Filtered Tables" = Table.Combine(#"Grouped and Filtered"[FilteredRows]),

    // Section 3: Final filtering and grouping (now on the minimal, correct dataset)
    #"Filtered Rows to Keep" = Table.SelectRows(#"Combined Filtered Tables", each [IsIncluded] = true),
    #"Renamed Columns" = Table.RenameColumns(#"Filtered Rows to Keep",{{"Column8", "APO Customer Name"}, {"Column14", "Data"}}),
    
    // Group the final rows.
    #"Grouped Rows for Final Output" = Table.Group(#"Renamed Columns", 
        {"Country", "Local Item number", "APO Product (1-6-3-3)", "APO Customer", "APO Customer Name", "Location/Plant/Site", "Calendar year", "Calendar month", "NewKeyFigure"}, 
        {{"Data", each List.Sum([Data]), type nullable number}}
    ),
    
    // Final cleanup
    #"Renamed Key Figure Column" = Table.RenameColumns(#"Grouped Rows for Final Output", {{"NewKeyFigure", "Key Figures"}})

in
    #"Renamed Key Figure Column"
