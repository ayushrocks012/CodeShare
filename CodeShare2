Option Explicit

Public SapGuiAuto, WScript, msgcol
Public objGui As GuiApplication
Public objConn As GuiConnection
Public objSess As GuiSession
Public objSBar As GuiStatusbar
Public Const W_System As String = "PEA100"
Public Const Max_Possible_Session As Integer = 6

Sub StartExtract()

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    Dim i As Integer, j As Integer
    Dim W_conn As Object, W_Sess As Object
    Dim Session_Nr As Integer, Session_Nr_All As Integer
    Dim W_Ret As Boolean: W_Ret = False
    
    If objGui Is Nothing Then
        Set SapGuiAuto = GetObject("SAPGUI")
        If SapGuiAuto Is Nothing Then
            MsgBox "Cannot find SAP GUI.", vbCritical
            GoTo Cleanup
        End If
        Set objGui = SapGuiAuto.GetScriptingEngine
    End If

    Session_Nr = -1

    For i = 0 To objGui.Children.Count - 1
        Set W_conn = objGui.Children(i) ' Explicit numeric indexing
        
        Session_Nr_All = W_conn.Children.Count
        
        For j = 0 To W_conn.Children.Count - 1
            Set W_Sess = W_conn.Children(j) ' Explicit numeric indexing
            
            If (W_Sess.Info.SystemName & W_Sess.Info.Client) = W_System Then
                If W_Sess.Info.Transaction = "SESSION_MANAGER" _
                    Or W_Sess.Info.Transaction = "SMEN" _
                    Or W_Sess.Info.Transaction = "S000" Then
                    
                    Session_Nr = W_Sess.Info.SessionNumber - 1
                    
                    ' Explicit object hierarchy referencing
                    Set objConn = objGui.Children(i)
                    Set objSess = objConn.Children(j)
                    
                    W_Ret = True
                    GoTo RunScript
                End If
            End If
        Next
    Next

    If Session_Nr_All = Max_Possible_Session And Session_Nr = -1 Then
        MsgBox "Maximum number of sessions reached", vbCritical
        GoTo Cleanup
    End If

    If Session_Nr = -1 Then
        MsgBox "No active session to system " & W_System & ", or scripting is not enabled.", vbCritical
        GoTo Cleanup
    End If

    If IsObject(WScript) Then
        WScript.ConnectObject objSess, "on"
        WScript.ConnectObject objGui, "on"
    End If

    If Not objSess Is Nothing Then
        Set objSBar = objSess.FindById("wnd[0]/sbar")
    End If

RunScript:
    If W_Ret Then
        RunGUIScript
        objSess.EndTransaction
        Set objSess = Nothing
    End If

Cleanup:
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True

End Sub

Public Sub RunGUIScript()

    Dim filePath As String, fileName As String, fullFilePath As String
    Dim timeStamp As String
    
    ' Dynamic timestamped filename
    timeStamp = Format(Now(), "YYYYMMDD_HHMMSS")
    filePath = "Z:\Demand\Demand Review\2025\03 Mar 25\SAP H2H Report\"
    fileName = "H2H Usage Report " & timeStamp & ".XLSX"
    fullFilePath = filePath & fileName
    
    With objSess
        .FindById("wnd[0]/tbar[0]/okcd").Text = "mb51"
        .FindById("wnd[0]").sendVKey 0
        .FindById("wnd[0]/usr/ctxtWERKS-LOW").Text = "1534"
        .FindById("wnd[0]/usr/ctxtBUDAT-LOW").Text = "01.03.2025"
        .FindById("wnd[0]/usr/ctxtBUDAT-HIGH").Text = "31.03.2025"
        .FindById("wnd[0]/usr/radRFLAT_L").Select
        .FindById("wnd[0]/usr/ctxtALV_DEF").Text = "AYUSH_TRY"
        .FindById("wnd[0]/tbar[1]/btn[8]").press
        .FindById("wnd[0]/usr/cntlGRID1/shellcont/shell").SelectContextMenuItem "&XXL"
        .FindById("wnd[1]/tbar[0]/btn[0]").press
        .FindById("wnd[1]/usr/ctxtDY_PATH").Text = filePath
        .FindById("wnd[1]/usr/ctxtDY_FILENAME").Text = fileName
        .FindById("wnd[1]/tbar[0]/btn[0]").press
        .FindById("wnd[0]/tbar[0]/btn[15]").press
        .FindById("wnd[0]/tbar[0]/btn[15]").press
    End With

    MsgBox "Data extraction successful!" & vbNewLine & "File saved as: " & vbNewLine & fullFilePath, vbInformation

End Sub
